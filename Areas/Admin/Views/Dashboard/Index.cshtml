@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<link rel = "stylesheet" href = "~/css/Admin/DashBoar.css"/>

<div class = "container-fluid mt-4">
    <!-- BỘ LỌC THỜI GIAN -->
    <div class = "row g-4 mb-4">
        <form asp-action = "Index" asp-controller = "Dashboard" asp-area = "Admin" method = "get" id = "filterForm">
            <div class = "row mb-3">
                <div class = "col-md-3">
                    <input type = "date" id = "startDate" name = "startDate" class = "form-control" value = "@ViewBag.StartDate"/>
                </div>
                <div class = "col-md-3">
                    <input type = "date" id = "endDate" name = "endDate" class = "form-control" value = "@ViewBag.EndDate"/>
                </div>
                <div class = "col-md-3">
                    <button type = "submit" class = "btn btn-primary w-100" onclick = "applyFilter()">Lọc</button>
                </div>
                <div class = "col-md-3">
                    <a href = "@Url.Action("Index", "Dashboard", new { area = "Admin" })" class = "btn btn-secondary w-100" onclick = "clearFilter()">Xóa
                        bộ lọc</a>
                </div>
            </div>
        </form>
    </div>

    <!-- THỐNG KÊ TỔNG QUAN -->
    <div class = "row g-4 mb-4">
        <div class = "col-md-3">
            <div class = "stat-card glass-card">
                <div class = "stat-icon primary"><i class = "fas fa-users"></i></div>
                <div class = "stat-value">@ViewBag.TotalUsers</div>
                <div class = "stat-label">Người dùng</div>
            </div>
        </div>
        <div class = "col-md-3">
            <div class = "stat-card glass-card">
                <div class = "stat-icon success"><i class = "fas fa-shopping-cart"></i></div>
                <div class = "stat-value">@ViewBag.TotalOrders</div>
                <div class = "stat-label">Đơn hàng</div>
            </div>
        </div>
        <div class = "col-md-3">
            <div class = "stat-card glass-card">
                <div class = "stat-icon warning"><i class = "fas fa-dollar-sign"></i></div>
                <div class = "stat-value">@ViewBag.TotalRevenue.ToString("N0") VNĐ</div>
                <div class = "stat-label">Doanh thu</div>
            </div>
        </div>
        <div class = "col-md-3">
            <div class = "stat-card glass-card">
                <div class = "stat-icon danger"><i class = "fas fa-box"></i></div>
                <div class = "stat-value">@ViewBag.TotalProducts</div>
                <div class = "stat-label">Sản phẩm</div>
            </div>
        </div>
    </div>

    <!-- BIỂU ĐỒ DOANH THU -->
    <div class = "row g-4">
        <div class = "glass-card p-4 h-100">
            <h5 class = "text-white mb-3">💰 Biểu đồ Doanh thu</h5>
            <canvas id = "revenueChart" style = "height:300px;"></canvas>
        </div>

        <!-- TOP SẢN PHẨM -->
        <div class = "col-lg-12">
            <div class = "glass-card p-4 h-100">
                <h5 class = "text-white mb-3">🔥 Top 5 sản phẩm bán chạy</h5>
                <ul class = "list-group list-group-flush">
                    @foreach (var item in ViewBag.BestSellingProducts)
                    {
                        <li class = "list-group-item d-flex align-items-center justify-content-between">
                            <div class = "d-flex align-items-center">
                                <img src = "~/img/product/@item.Image" class = "rounded me-2" style = "width:50px;height:50px;object-fit:cover;"/>
                                <span>@item.ProductName</span>
                            </div>
                            <span class = "badge bg-success">@item.Quantity</span>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>

    <!-- TOP THEO DANH MỤC -->
    <div class = "row g-4 mt-4">
        @foreach (var category in ViewBag.BestSellingByCategory)
        {
            <div class = "col-md-6">
                <div class = "glass-card p-4">
                    <h5 class = "text-white mb-3">📦 Top sản phẩm - @category.CategoryName</h5>
                    <table class = "table table-striped table-modern">
                        <thead>
                        <tr>
                            <th>Sản phẩm</th>
                            <th>Ảnh</th>
                            <th>Bán</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var product in category.Products)
                        {
                            <tr>
                                <td>@product.ProductName</td>
                                <td>
                                    <img src = "~/img/product/@product.Image" style = "width:60px;height:60px;object-fit:cover;"/>
                                </td>
                                <td>@product.Quantity</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>

    <!-- TOP NGƯỜI DÙNG CHI TIÊU -->
    <div class = "col-lg-12 mt-4">
        <div class = "glass-card p-4 h-100">
            <h5 class = "text-white mb-3">👑 Top 5 người dùng chi tiêu nhiều nhất</h5>
            <ul class = "list-group list-group-flush">
                @foreach (var user in ViewBag.TopSpendingUsers)
                {
                    <li class = "list-group-item d-flex align-items-center justify-content-between">
                        <span>@user.UserName</span>
                        <span class = "badge bg-primary">@user.TotalSpent.ToString("N0") VNĐ</span>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>

@section Scripts {
    <script src = "https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chart;

        async function loadRevenue(type) {
            let url = '';
            let label = '';

            let start = document.getElementById('startDate').value;
            let end = document.getElementById('endDate').value;

            if (type === 'day') {
                url = '@Url.Action("GetRevenueByDay", "Dashboard", new { area = "Admin" })';
                label = "Doanh thu theo giờ hôm nay";
            } else if (type === 'month') {
                url = '@Url.Action("GetRevenueByMonth", "Dashboard", new { area = "Admin" })';
                label = "Doanh thu theo tháng " + new Date().getFullYear();
            } else if (type === 'year') {
                url = '@Url.Action("GetRevenueByYear", "Dashboard", new { area = "Admin" })';
                label = "Doanh thu theo năm";
            } else if (type === 'custom' && start && end) {
                url = '@Url.Action("GetRevenueByRange", "Dashboard", new { area = "Admin" })' + `?startDate=${start}&endDate=${end}`;
                label = `Doanh thu từ ${start} đến ${end}`;
            } else if (type === 'custom') {
                alert("Vui lòng chọn đầy đủ ngày bắt đầu và kết thúc");
                return;
            }

            if (start && end && type !== 'custom') {
                url = '@Url.Action("GetRevenueByRange", "Dashboard", new { area = "Admin" })' + `?startDate=${start}&endDate=${end}`;
                label = `Doanh thu từ ${start} đến ${end}`;
            }

            const response = await fetch(url);
            const data = await response.json();

            let labels, revenues;
            if (type === 'day' && !start && !end) {
                labels = data.map(x => x.hour + "h");
                revenues = data.map(x => x.revenue);
            } else if (type === 'month' && !start && !end) {
                labels = data.map(x => "Tháng " + x.month);
                revenues = data.map(x => x.revenue);
            } else if (type === 'year' && !start && !end) {
                labels = data.map(x => x.year);
                revenues = data.map(x => x.revenue);
            } else {
                labels = data.map(x => new Date(x.date).toLocaleDateString("vi-VN"));
                revenues = data.map(x => x.revenue);
            }

            const ctx = document.getElementById('revenueChart').getContext('2d');
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: revenues,
                        fill: true,
                        backgroundColor: 'rgba(75,192,192,0.2)',
                        borderColor: 'rgba(75,192,192,1)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {display: true, position: 'top'},
                        tooltip: {
                            callbacks: {
                                label: context => context.raw.toLocaleString("vi-VN") + " VNĐ"
                            }
                        }
                    },
                    scales: {
                        y: {beginAtZero: true, ticks: {callback: val => val.toLocaleString("vi-VN") + " đ"}}
                    }
                }
            });
        }

        function applyFilter() {
            let start = document.getElementById('startDate').value;
            let end = document.getElementById('endDate').value;
            if (start && end) {
                loadRevenue('custom');
            }
        }

        function clearFilter() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            loadRevenue('month');
        }

        window.onload = function () {
            let start = '@ViewBag.StartDate';
            let end = '@ViewBag.EndDate';
            if (start && end) {
                loadRevenue('custom');
            } else {
                loadRevenue('month');
            }
        };
    </script>
}