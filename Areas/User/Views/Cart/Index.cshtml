@model MyWebApp.ViewModels.CartItemViewModel
@{
    ViewData["Title"] = "Giỏ hàng";
    ViewData["col-12"] = true;
}
<link rel = "stylesheet" href = "~/css/User/CartIndex.css"/>

<div class = "cart-container">
    <div class = "container">
        <!-- Header -->
        <div class = "cart-header fade-in">
            <div class = "d-flex align-items-center justify-content-between">
                <div>
                    <h1 class = "cart-title">
                        <i class = "fas fa-shopping-cart me-3"></i>
                        Giỏ hàng của bạn
                    </h1>
                    <p class = "cart-subtitle">Quản lý các sản phẩm bạn muốn mua</p>
                </div>
            </div>
        </div>

        @if (!Model.CartItems.Any())
        {
            <div class = "empty-cart fade-in text-center">
                <div class = "empty-cart-icon">
                    <i class = "fas fa-shopping-cart"></i>
                </div>
                <h3 class = "mb-3">Giỏ hàng của bạn đang trống</h3>
                <p class = "text-muted mb-4">Khám phá các sản phẩm laptop và PC tuyệt vời của chúng tôi</p>
                <a asp-action = "Index" asp-controller = "Product" class = "modern-btn modern-btn-lg">
                    <i class = "fas fa-arrow-left"></i> Bắt đầu mua sắm
                </a>
            </div>
        }
        else
        {
            <div class = "row">
                <!-- Cart Items -->
                <div class = "col-lg-8">
                    <div class = "cart-table-container slide-in">
                        <table class = "table modern-table">
                            <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Thành tiền</th>
                                <th>Xóa</th>
                            </tr>
                            </thead>
                            <tbody>
                            @* @foreach (var item in Model.CartItems) *@
                            @* { *@
                            @*     <tr> *@
                            @*         <td> *@
                            @*             <div class = "d-flex align-items-center gap-5"> *@
                            @*                 <img src = "~/img/product/@item.ImageUrl" class = "product-image" alt = "@item.ProductName"/> *@
                            @*                 <div> *@
                            @*                     <div class = "product-name">@item.ProductName</div> *@
                            @*                 </div> *@
                            @*             </div> *@
                            @*         </td> *@
                            @*         <td> *@
                            @*             <div class = "quantity-controls"> *@
                            @*                 <button class = "quantity-btn decrease-btn" data-id = "@item.CartItemId">− *@
                            @*                 </button> *@
                            @*                 <span class = "quantity">@item.Quantity</span> *@
                            @*                 <button class = "quantity-btn increase-btn" data-id = "@item.CartItemId">+ *@
                            @*                 </button> *@
                            @*             </div> *@
                            @*             @if (TempData["ErrorProductId"]?.ToString() == item.CartItemId.ToString()) *@
                            @*             { *@
                            @*                 <div class = "text-danger small text-center mt-1">@TempData["Error"]</div> *@
                            @*             } *@
                            @*         </td> *@
                            @*         <td class = "subtotal">@(((item.DiscountPrice ?? item.Price) * item.Quantity).ToString("N0")) ₫</td> *@
                            @* *@
                            @*         <td> *@
                            @*             <button class = "remove-btn btn btn-link text-danger" data-id = "@item.CartItemId"> *@
                            @*                 <i class = "fas fa-trash-alt"></i> *@
                            @*             </button> *@
                            @*         </td> *@
                            @*     </tr> *@
                            @* } *@
                            @foreach (var item in Model.CartItems.Where(ci => !ci.IsGift))
                            {
                                <tr>
                                    <td>
                                        <div class = "d-flex align-items-center gap-5">
                                            <img src = "~/img/product/@item.ImageUrl" class = "product-image" alt = "@item.ProductName"/>
                                            <div>
                                                <div class = "product-name">@item.ProductName</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class = "quantity-controls">
                                            <button class = "quantity-btn decrease-btn" data-id = "@item.CartItemId">−
                                            </button>
                                            <span class = "quantity">@item.Quantity</span>
                                            <button class = "quantity-btn increase-btn" data-id = "@item.CartItemId">+
                                            </button>
                                        </div>
                                        @if (TempData["ErrorProductId"]?.ToString() == item.CartItemId.ToString())
                                        {
                                            <div class = "text-danger small text-center mt-1">@TempData["Error"]</div>
                                        }
                                    </td>
                                    <td class = "subtotal">@(((item.DiscountPrice ?? item.Price) * item.Quantity).ToString("N0")) ₫</td>
                                    <td>
                                        <button class = "remove-btn btn btn-link text-danger" data-id = "@item.CartItemId">
                                            <i class = "fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            }

                            @if (Model.CartItems.Any(ci => ci.IsGift))
                            {
                                <tr class = "gift-section">
                                    <td colspan = "4" class = "text-center py-3">
                                        <div class = "alert alert-success d-flex align-items-center justify-content-center">
                                            <i class = "fas fa-gift me-2"></i>
                                            <strong>🎁 Quà tặng đặc biệt cho bạn!</strong>
                                        </div>
                                    </td>
                                </tr>

                                @foreach (var gift in Model.CartItems.Where(ci => ci.IsGift))
                                {
                                    <tr class = "table-success" data-id = "@gift.CartItemId">
                                        <td>
                                            <div class = "d-flex align-items-center gap-3">
                                                <img src = "~/img/product/@gift.ImageUrl" alt = "@gift.ProductName" width = "60" class = "rounded"/>
                                                <div>
                                                    <div class = "product-name small">@gift.ProductName</div>
                                                    <span class = "badge bg-success">🎁 Quà tặng</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class = "small">@gift.Quantity x</span>
                                        </td>
                                        <td>
                                            <span class = "text-success small">0 ₫</span>
                                        </td>
                                        <td>
                                            <span class = "text-muted small">—</span>
                                        </td>
                                    </tr>
                                }
                            }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Cart Summary -->
                <div class = "col-lg-4">
                    <div class = "cart-summary fade-in">
                        <h4 class = "section-title">
                            <span class = "section-icon"><i class = "fas fa-calculator"></i></span>
                            Tóm tắt đơn hàng
                        </h4>

                        <div class = "summary-row">
                            <span class = "summary-label">Tổng tiền sản phẩm:</span>
                            <span id = "cartTotal" class = "summary-value">@Model.TotalPrice.ToString("N0") ₫</span>
                        </div>
                        <div class = "summary-row">
                            <span class = "summary-label">Phí vận chuyển:</span>
                            <span id = "shippingFee" class = "summary-value">0 ₫</span>
                        </div>

                        <div class = "summary-row">
                            <span class = "summary-label">Mã giảm giá:</span>
                            <span id = "discountDisplay" class = "summary-value">0 ₫</span>
                        </div>

                        <div class = "summary-row">
                            <span class = "summary-label fs-4">Tổng cộng:</span>
                            <span id = "grandTotal" class = "summary-value grand-total">@Model.TotalPrice.ToString("N0") ₫</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discount Section -->
            <div class = "discount-section fade-in">
                <h4 class = "section-title text-warning">
                    <span class = "section-icon bg-warning"><i class = "fas fa-tag"></i></span>
                    Mã giảm giá
                </h4>
                <p class = "text-muted mb-3">Nhập mã giảm giá để được ưu đãi tốt nhất</p>
                <form id = "discountForm">
                    <div class = "discount-input-group">
                        <input type = "text" id = "discountCode" class = "discount-input" placeholder = "Nhập mã giảm giá của bạn"/>
                        <button type = "submit" class = "discount-btn"><i class = "fas fa-check"></i> Áp dụng</button>
                    </div>
                    <div id = "discountMessage" class = "mt-2"></div>
                </form>
            </div>

            <div class = "row">
                <!-- Shipping Information -->
                <div class = "col-md-6">
                    <div class = "info-section fade-in">
                        <h4 class = "section-title"><span class = "section-icon"><i class = "fas fa-truck"></i></span>
                            Thông tin giao hàng</h4>
                        <form id = "shippingForm">
                            <div class = "mb-3">
                                <label class = "form-label fw-semibold">Tỉnh/Thành phố</label>
                                <select id = "tinh" class = "form-select modern-form-control" required>
                                    <option value = "">-- Chọn Tỉnh/Thành phố --</option>
                                </select>
                                <input type = "hidden" id = "City" name = "City"/>
                            </div>
                            <div class = "mb-3">
                                <label class = "form-label fw-semibold">Quận/Huyện</label>
                                <select id = "quan" class = "form-select modern-form-control" required>
                                    <option value = "">-- Chọn Quận/Huyện --</option>
                                </select>
                                <input type = "hidden" id = "District" name = "District"/>
                            </div>
                            <div class = "mb-3">
                                <label class = "form-label fw-semibold">Địa chỉ chi tiết</label>
                                <input id = "FullAddressInput" name = "FullAddress" class = "form-control modern-form-control" placeholder = "Số nhà, tên đường, phường/xã..." required/>
                            </div>
                            <div class = "mb-3">
                                <label class = "form-label fw-semibold">Số điện thoại</label>
                                <input
                                    id = "PhoneNumberInput" name = "PhoneNumber" type = "tel" class = "form-control modern-form-control"
                                    placeholder = "Nhập số điện thoại của bạn" required pattern = "[0-9]{10,11}"
                                />
                            </div>

                        </form>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class = "col-md-6">
                    <div class = "info-section fade-in">
                        <h4 class = "section-title">
                            <span class = "section-icon"><i class = "fas fa-credit-card"></i></span> Phương thức thanh
                            toán</h4>
                        <form id = "paymentForm">
                            <div class = "payment-option active">
                                <div class = "form-check">
                                    <input class = "form-check-input" type = "radio" name = "PaymentMethod" id = "paymentCOD" value = "COD" checked>
                                    <label class = "form-check-label fw-semibold" for = "paymentCOD">
                                        <i class = "fas fa-money-bill-wave me-2"></i> Thanh toán khi nhận hàng (COD)
                                    </label>
                                </div>
                            </div>
                            <div class = "payment-option">
                                <div class = "form-check">
                                    <input class = "form-check-input" type = "radio" name = "PaymentMethod" id = "paymentMomo" value = "Momo">
                                    <label class = "form-check-label fw-semibold" for = "paymentMomo">
                                        <i class = "fab fa-paypal me-2"></i> Thanh toán qua MoMo
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class = "action-buttons fade-in mt-4 d-flex justify-content-between">
                <a asp-action = "Index" asp-controller = "Home" class = "modern-btn modern-btn-outline">
                    <i class = "fas fa-arrow-left"></i> Tiếp tục mua sắm
                </a>

                @if (User.Identity?.IsAuthenticated ?? false)
                {
                    <form id = "checkoutForm" asp-controller = "Checkout" asp-action = "Checkout" method = "post">
                        <input type = "hidden" id = "shipingId" name = "shipingId"/>
                        <input type = "hidden" id = "discountAmount" name = "discountAmount"/>
                        <input type = "hidden" id = "discountCodeHidden" name = "discountCode"/>
                        <input type = "hidden" id = "fullAddressHidden" name = "FullAddress"/>
                        <input type = "hidden" id = "paymentMethodHidden" name = "PaymentMethod"/>
                        <input type = "hidden" id = "phoneHidden" name = "PhoneNumber"/>
                        <button type = "submit" class = "modern-btn modern-btn-success modern-btn-lg">
                            <i class = "fas fa-lock me-1"></i> Thanh toán an toàn
                        </button>
                    </form>
                }
                else
                {
                    <a asp-area = "User" asp-controller = "Account" asp-action = "Login" class = "modern-btn modern-btn-lg">
                        <i class = "fas fa-sign-in-alt me-1"></i> Đăng nhập để thanh toán
                    </a>
                }
            </div>
        }
    </div>
</div>

@section Scripts{
    <script src = "https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function () {

            // --- Load Tỉnh ---
            $.getJSON('https://esgoo.net/api-tinhthanh-new/1/0.htm', function (data) {
                if (data.error === 0) {
                    $.each(data.data, (_, val) => $("#tinh").append(`<option value="${val.id}">${val.full_name}</option>`));
                }
            });

            // --- Chọn Tỉnh load Quận ---
            $("#tinh").change(function () {
                $("#City").val($("#tinh option:selected").text());
                $("#quan").html('<option value="">-- Chọn Quận/Huyện --</option>');
                let idtinh = $(this).val();
                $.getJSON(`https://esgoo.net/api-tinhthanh-new/2/${idtinh}.htm`, function (data) {
                    if (data.error === 0) {
                        $.each(data.data, (_, val) => $("#quan").append(`<option value="${val.full_name}">${val.full_name}</option>`));
                    }
                });
                updateShippingFee();
            });

            $("#quan").change(function () {
                $("#District").val($("#quan option:selected").text());
                updateShippingFee();
            });

            let fullAddr = $("#FullAddressInput").val().trim();
            $("#fullAddressHidden").val(fullAddr);

            // --- Áp dụng mã giảm giá ---
            $("#discountForm").submit(function (e) {
                e.preventDefault();
                let code = $("#discountCode").val().trim();
                if (!code) return;

                $.getJSON('/User/Cart/ApplyDiscount', {code: code}, function (res) {
                    if (res.success) {
                        $("#discountMessage").removeClass('text-danger').addClass('text-success').text(res.message);
                        // Lưu thông tin giảm giá vào data
                        $("#discountAmount").data("fixed", res.discountAmount || 0);
                        $("#discountAmount").data("percent", res.discountPercent || 0);
                        $("#discountCodeHidden").val(code);
                        recalcDiscount();
                    } else {
                        $("#discountMessage").removeClass('text-success').addClass('text-danger').text(res.message);
                        $("#discountAmount").data("fixed", 0);
                        $("#discountAmount").data("percent", 0);
                        $("#discountAmount").val(0);
                        $("#discountDisplay").text('0 ₫');
                        $("#discountCodeHidden").val('');
                        recalcGrandTotal();
                    }
                });
            });

            // --- Tăng/Giảm/Xóa sản phẩm ---
            $(document).on("click", ".increase-btn", function () {
                updateCart("Increase", $(this).data("id"), $(this).closest("tr"));

            });

            $(document).on("click", ".decrease-btn", function () {
                updateCart("Decrease", $(this).data("id"), $(this).closest("tr"));
            });

            $(document).on("click", ".remove-btn", function () {
                let row = $(this).closest("tr");
                updateCart("Remove", $(this).data("id"), row);
                row.fadeOut(300, function () {
                    $(this).remove();
                });
            });

            function refreshGiftItems() {
                $.post('/User/Cart/RefreshGiftItems', function(res) {
                    if (res.success) {
                        // Xóa các hàng quà tặng hiện tại
                        $('tr.table-success').remove();
                        $('tr.gift-section').remove();

                        // Nếu có quà tặng, thêm tiêu đề và các hàng quà tặng
                        if (res.hasGifts) {
                            // Thêm tiêu đề quà tặng
                            $('table.modern-table tbody').append(`
                    <tr class="gift-section">
                        <td colspan="4" class="text-center py-3">
                            <div class="alert alert-success d-flex align-items-center justify-content-center">
                                <i class="fas fa-gift me-2"></i>
                                <strong>🎁 Quà tặng đặc biệt cho bạn!</strong>
                            </div>
                        </td>
                    </tr>
                `);

                            // Thêm các hàng quà tặng
                            res.giftItems.forEach(function(gift) {
                                $('table.modern-table tbody').append(`
                        <tr class="table-success" data-id="${gift.cartItemId}">
                            <td>
                                <div class="d-flex align-items-center gap-3">
                                    <img src="/img/product/${gift.imageUrl}" alt="${gift.productName}" width="60" class="rounded"/>
                                    <div>
                                        <div class="product-name small">${gift.productName}</div>
                                        <span class="badge bg-success">🎁 Quà tặng</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="small">${gift.quantity} x</span>
                            </td>
                            <td>
                                <span class="text-success small">0 ₫</span>
                            </td>
                            <td>
                                <span class="text-muted small">—</span>
                            </td>
                        </tr>
                    `);
                            });
                        }

                        // Cập nhật tổng tiền
                        $("#cartTotal").text(res.newTotalPrice.toLocaleString() + ' ₫');
                        recalcDiscount();
                    }
                });
            }

            function updateCart(action, id, row) {
                $.post(`/User/Cart/${action}`, {id}, function (res) {
                    if (res.success) {
                        // Giỏ hàng trống
                        if (res.cartEmpty) {
                            $(".cart-table-container, .cart-summary, .discount-section, .info-section, .action-buttons").remove();
                            $(".cart-container .container").append(`
                    <div class="empty-cart fade-in text-center">
                        <div class="empty-cart-icon"><i class="fas fa-shopping-cart"></i></div>
                        <h3 class="mb-3">Giỏ hàng của bạn đang trống</h3>
                        <p class="text-muted mb-4">Khám phá các sản phẩm laptop và PC tuyệt vời của chúng tôi</p>
                        <a href="${'@Url.Action("Index", "Product")'}" class="modern-btn modern-btn-lg">
                            <i class="fas fa-arrow-left"></i> Bắt đầu mua sắm
                        </a>
                    </div>
                `);
                            return;
                        }

                        // Xử lý xóa hoặc thay đổi số lượng
                        if (action === "Remove" || res.removed) {
                            if (!row.hasClass('table-success')) {
                                row.fadeOut(300, function () {
                                    $(this).remove();
                                });
                            }
                        } else {
                            row.find(".quantity").text(res.newQuantity);
                            row.find(".subtotal").text(res.newSubtotal.toLocaleString() + ' ₫');
                        }

                        // Cập nhật quà tặng
                        refreshGiftItems();
                    } else {
                        alert(res.message || 'Có lỗi xảy ra');
                    }
                });
            }

            // --- Hàm cập nhật Grand Total ---
            function recalcGrandTotal() {
                let total = 0;
                $("tbody tr").each(function () {
                    total += parseInt($(this).find(".subtotal").text().replace(/\D/g, '')) || 0;
                });
                let shipping = parseInt($("#shippingFee").text().replace(/\D/g, '')) || 0;
                let discount = parseInt($("#discountAmount").val()) || 0;
                let grand = total + shipping - discount;
                if (grand < 0) grand = 0;
                $("#grandTotal").text(grand.toLocaleString() + ' ₫');
                $("#cartTotal").text(total.toLocaleString() + ' ₫');
            }

            // --- Hàm cập nhật discount theo subtotal ---
            function recalcDiscount() {
                let cartTotal = 0;
                $("tbody tr").each(function () {
                    cartTotal += parseInt($(this).find(".subtotal").text().replace(/\D/g, '')) || 0;
                });

                let fixed = parseInt($("#discountAmount").data("fixed") || 0);
                let percent = parseFloat($("#discountAmount").data("percent") || 0);

                let discountTotal = fixed + Math.round(percent * cartTotal / 100);
                $("#discountAmount").val(discountTotal);
                $("#discountDisplay").text(discountTotal.toLocaleString() + ' ₫');

                recalcGrandTotal();
            }

            // --- Cập nhật phí vận chuyển ---
            function updateShippingFee() {
                let city = $("#City").val(), district = $("#District").val();
                if (city && district) {
                    $.getJSON('/User/Cart/GetShippingFee', {city, district}, function (res) {
                        $("#shippingFee").text((res.price || 0).toLocaleString() + ' ₫');
                        $("#shipingId").val(res.id);
                        recalcGrandTotal();
                    });
                } else recalcGrandTotal();
            }

            // --- Checkout ---
            $("#checkoutForm").submit(function (e) {
                let fullAddr = $("input[name='FullAddress']").val().trim(),
                    shippingId = $("#shipingId").val(),
                    discountCode = $("#discountCodeHidden").val(),
                    paymentMethod = $("input[name='PaymentMethod']:checked").val(),
                    phone = $("#PhoneNumberInput").val().trim();
                if (!fullAddr || !shippingId || !phone) {
                    e.preventDefault();
                    alert("Vui lòng nhập đầy đủ địa chỉ và số điện thoại.");
                    return;
                }
                $("#phoneHidden").val(phone);
                $("#fullAddressHidden").val(fullAddr);
                $("#paymentMethodHidden").val(paymentMethod);

                if (paymentMethod === "Momo") {
                    e.preventDefault();
                    window.location.href = `/User/Checkout/CreateMomoPayment?FullAddress=${
                        encodeURIComponent(fullAddr)}&shipingId=${encodeURIComponent(shippingId)}&discountCode=${encodeURIComponent(discountCode || "")}&phone=${encodeURIComponent(phone)}`;
                }
            });

            // --- Cập nhật nút Checkout ---
            $("input[name='PaymentMethod']").change(function () {
                $("#checkoutForm button[type='submit']").text($(this).val() === "Momo" ? "Chuyển đến Thanh Toán MoMo" : "Thanh toán");
            });

        });
    </script>
}






