@model MyWebApp.Models.Product

@{
    ViewData["Title"] = "Chi tiết sản phẩm - " + Model.Name;
}
<style>
    .badge {
        font-size: 1rem;
        padding: 0.5em 0.75em;
    }
</style>

<div class = "container my-5">
    @Html.AntiForgeryToken()
    <div class = "row g-5">
        <!-- Hình ảnh sản phẩm -->
        <div class = "col-md-5">
            <div class = "border rounded shadow-sm p-3 bg-white">
                <img src = "~/img/product/@Model.Image" class = "img-fluid rounded" alt = "@Model.Name"/>
            </div>
        </div>

        <!-- Thông tin sản phẩm -->
        <div class = "col-md-7">
            <div class = "border rounded shadow-sm p-4 bg-white">
                <h2 class = "fw-bold text-primary">@Model.Name</h2>

                <p class = "mt-3">
                    <i class = "fa fa-tag me-1 text-muted"></i>
                    <strong>Giá:</strong>
                    <span class = "text-danger fw-bold h4">@Model.Price.ToString("N0") ₫</span>
                </p>

                <p>
                    <i class = "fa fa-boxes me-1 text-muted"></i>
                    <strong>Số lượng còn:</strong>
                    <span class = "text-dark">@Model.Quantity</span>
                </p>

                <p>
                    <i class = "fa fa-calendar-alt me-1 text-muted"></i>
                    <strong>Ngày tạo:</strong>
                    <span class = "text-dark">@Model.CreatedAt.ToString("dd/MM/yyyy")</span>
                </p>

                <p>
                    <i class = "fa fa-list-alt me-1 text-muted"></i>
                    <strong>Danh mục:</strong>
                    <span class = "badge bg-info text-dark">@Model.Category?.Name</span>
                </p>

                <p>
                    <i class = "fa fa-copyright me-1 text-muted"></i>
                    <strong>Thương hiệu:</strong>
                    <span class = "badge bg-secondary">@Model.Brand?.Name</span>
                </p>

                <button
                    type = "button"
                    class = "btn btn-success btn-add-to-cart"
                    data-id = "@Model.Id"
                >
                    <i class = "fa fa-cart-plus me-1"></i> Thêm vào giỏ hàng
                </button>

            </div>
        </div>
    </div>
    <!-- Mô tả sản phẩm -->
    <div class = "row mt-5">
        <div class = "col-12">
            <div class = "border rounded shadow-sm p-4 bg-light">
                <h4 class = "text-dark fw-semibold mb-3">
                    <i class = "fa fa-file-alt me-2 text-secondary"></i> Mô tả sản phẩm
                </h4>
                <div class = "text-secondary fs-6" style = "white-space: pre-line;">
                    @Html.Raw(Model.Description)
                </div>
            </div>
        </div>
    </div>
    <div class = "review-section mt-5">
        <div class = "card shadow-sm border-0">
            <div class = "card-header bg-warning text-dark fw-bold">
                <i class = "fa fa-star me-2"></i> Đánh giá & Bình luận
            </div>
            <div class = "card-body">
                <form method = "post" asp-action = "AddComment" asp-controller = "Product">
                    <input type = "hidden" name = "ProductId" value = "@Model.Id"/>

                    <!-- Rating -->
                    <div class = "mb-3">
                        <label for = "Rating" class = "form-label">Đánh giá sao:</label>
                        <select class = "form-select w-auto d-inline-block" name = "Rating" id = "Rating">
                            <option value = "5">⭐⭐⭐⭐⭐</option>
                            <option value = "4">⭐⭐⭐⭐</option>
                            <option value = "3">⭐⭐⭐</option>
                            <option value = "2">⭐⭐</option>
                            <option value = "1">⭐</option>
                        </select>
                    </div>
                    @if (User.Identity?.IsAuthenticated ?? false)
                    {
                        <!-- Comment content -->
                        <div class = "mb-3">
                            <label for = "Content" class = "form-label">Nội dung bình luận:</label>
                            <textarea class = "form-control" name = "Content" id = "Content" rows = "3" placeholder = "Viết bình luận..." required></textarea>
                        </div>

                        <!-- Submit -->
                        <button type = "submit" class = "btn btn-success">
                            <i class = "fa fa-paper-plane me-1"></i> Gửi bình luận
                        </button>
                    }
                    else
                    {
                        <a asp-area = "User" asp-controller = "Account" asp-action = "Login" class = "btn btn-primary">Đăng
                            nhập để bình luận</a>
                    }

                </form>
            </div>
        </div>

        <!-- Danh sách bình luận -->
        <div class = "mt-4">
            <h5 class = "text-dark mb-3">
                <i class = "fa fa-comments me-2 text-secondary"></i> Bình luận gần đây
            </h5>

            <!-- Danh sách bình luận -->
            <div class = "comments-list">
                @if (Model.Comments != null && Model.Comments.Any())
                {
                    @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                    {
                        <div class = "card mb-3 border-0 shadow-sm">
                            <div class = "card-body">
                                <div class = "d-flex justify-content-between mb-2">
                                    <strong class = "text-dark">
                                        👤 @comment.User?.UserName
                                    </strong>
                                    <small class = "text-muted">@comment.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                </div>

                                <!-- Rating sao -->
                                <div class = "mb-2 text-warning">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= comment.Rating)
                                        {
                                            <i class = "fa fa-star"></i>
                                        }
                                        else
                                        {
                                            <i class = "fa fa-star text-secondary"></i>
                                        }
                                    }
                                </div>

                                <p class = "text-secondary mb-0">@comment.Content</p>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class = "alert alert-info">Chưa có bình luận nào.</div>
                }
            </div>

        </div>
    </div>

</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const addToCartBtn = document.querySelector(".btn-add-to-cart");

            addToCartBtn?.addEventListener("click", function (e) {
                e.preventDefault();

                const productId = this.dataset.id;
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                const params = new URLSearchParams();
                params.append("Id", productId);
                params.append("__RequestVerificationToken", token);

                fetch('/User/Cart/Add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: params
                })

                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            showToast(data.message, "success");
                            document.querySelector("#cartCount").textContent = data.cartCount;
                        } else {
                            showToast("Thêm không thành công", "danger");
                        }
                    })
            });

            function showToast(message, type) {
                const toastContainer = document.getElementById("toast-container") || createToastContainer();

                const toast = document.createElement("div");
                toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
                toast.setAttribute("role", "alert");
                toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
                toastContainer.appendChild(toast);

                setTimeout(() => toast.remove(), 3000);
            }

            function createToastContainer() {
                const container = document.createElement("div");
                container.id = "toast-container";
                container.style.position = "fixed";
                container.style.top = "1rem";
                container.style.right = "1rem";
                container.style.zIndex = "1055";
                document.body.appendChild(container);
                return container;
            }


        });


    </script>
}
