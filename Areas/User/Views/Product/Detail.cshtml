@using MyWebApp.Models
@model MyWebApp.Models.Product

@{
    ViewData["Title"] = "Chi tiết sản phẩm - " + Model.Name;
}
<link rel="stylesheet" href="~/css/User/ProductDetail.css" />

<div class = "container my-5">
    @Html.AntiForgeryToken()
    <div class = "row g-5">
        <!-- Hình ảnh sản phẩm -->
        <div class = "col-md-5">
            <div class = "border rounded shadow-sm p-3 bg-white">
                <img src = "~/img/product/@Model.Image" class = "img-fluid rounded" alt = "@Model.Name"/>
            </div>
        </div>

        <!-- Thông tin sản phẩm -->
        <div class = "col-md-7">
            <div class = "border rounded shadow-sm p-4 bg-white">
                <h2 class = "fw-bold text-primary">@Model.Name</h2>

                <p class = "mt-3">
                    <i class = "fa fa-tag me-1 text-muted"></i>
                    <strong>Giá:</strong>
                    <span class = "text-danger fw-bold h4">@Model.Price.ToString("N0") ₫</span>
                </p>

                <p>
                    <i class = "fa fa-boxes me-1 text-muted"></i>
                    <strong>Số lượng còn:</strong>
                    <span class = "text-dark">@Model.Quantity</span>
                </p>

                <p>
                    <i class = "fa fa-calendar-alt me-1 text-muted"></i>
                    <strong>Ngày tạo:</strong>
                    <span class = "text-dark">@Model.CreatedAt.ToString("dd/MM/yyyy")</span>
                </p>

                <p>
                    <i class = "fa fa-list-alt me-1 text-muted"></i>
                    <strong>Danh mục:</strong>
                    <span class = "badge bg-info text-dark">@Model.Category?.Name</span>
                </p>

                <p>
                    <i class = "fa fa-copyright me-1 text-muted"></i>
                    <strong>Thương hiệu:</strong>
                    <span class = "badge bg-secondary">@Model.Brand?.Name</span>
                </p>

                @if (@Model.Quantity > 0)
                {
                    <button
                        type = "button"
                        class = "btn btn-success mt-2 btn-add-to-cart w-100"
                        data-id = "@Model.Id"
                    >
                        <i class = "fa fa-cart-plus me-1"></i> Thêm vào giỏ hàng
                    </button>
                }
                else
                {
                    <button
                        type = "button"
                        class = "btn btn-secondary mt-2 w-100"
                        disabled
                    >
                        <i class = "fa fa-ban me-1"></i> Hết hàng
                    </button>
                }

            </div>
        </div>
    </div>
    <!-- Mô tả sản phẩm -->
    <div class = "row mt-5">
        <div class = "col-12">
            <div class = "border rounded shadow-sm p-4 bg-light">
                <h4 class = "text-dark fw-semibold mb-3">
                    <i class = "fa fa-file-alt me-2 text-secondary"></i> Mô tả sản phẩm
                </h4>
                <div class = "text-secondary fs-6" style = "white-space: pre-line;">
                    @Html.Raw(Model.Description)
                </div>
            </div>
        </div>
    </div>
    <div class = "review-section mt-5">
        <div class = "card shadow-sm border-0">
            <div class = "card-header bg-warning text-dark fw-bold">
                <i class = "fa fa-star me-2"></i> Đánh giá & Bình luận
            </div>
            <div class = "card-body">
                <form method = "post" asp-action = "AddComment" asp-controller = "Product">
                    <input type = "hidden" name = "ProductId" value = "@Model.Id"/>

                    <!-- Rating -->
                    <div class = "mb-3">
                        <label for = "Rating" class = "form-label">Đánh giá sao:</label>
                        <select class = "form-select w-auto d-inline-block" name = "Rating" id = "Rating">
                            <option value = "5">⭐⭐⭐⭐⭐</option>
                            <option value = "4">⭐⭐⭐⭐</option>
                            <option value = "3">⭐⭐⭐</option>
                            <option value = "2">⭐⭐</option>
                            <option value = "1">⭐</option>
                        </select>
                    </div>
                    @if (User.Identity?.IsAuthenticated ?? false)
                    {
                        <!-- Comment content -->
                        <div class = "mb-3">
                            <label for = "Content" class = "form-label">Nội dung bình luận:</label>
                            <textarea class = "form-control" name = "Content" id = "Content" rows = "3" placeholder = "Viết bình luận..." required></textarea>
                        </div>

                        <!-- Submit -->
                        <button type = "submit" class = "btn btn-success">
                            <i class = "fa fa-paper-plane me-1"></i> Gửi bình luận
                        </button>
                    }
                    else
                    {
                        <a asp-area = "User" asp-controller = "Account" asp-action = "Login" class = "btn btn-primary">Đăng
                            nhập để bình luận</a>
                    }

                </form>
            </div>
        </div>

        <!-- Danh sách bình luận -->
        <div class = "mt-4">
            <h5 class = "text-dark mb-3">
                <i class = "fa fa-comments me-2 text-secondary"></i> Bình luận gần đây
            </h5>

            <!-- Danh sách bình luận -->
            <div class = "comments-list">
                @if (Model.Comments != null && Model.Comments.Any())
                {
                    @foreach (var comment in Model.Comments.Where(c => c.ParentCommentId == null).OrderByDescending(c => c.CreatedAt))
                    {
                        @await Html.PartialAsync("_CommentPartial", comment)
                    }
                }
                else
                {
                    <div class = "alert alert-info">Chưa có bình luận nào.</div>
                }

            </div>

        </div>
    </div>

    <!-- Sản phẩm liên quan -->
    @if (ViewBag.RelatedProducts != null && ((List<Product>)ViewBag.RelatedProducts).Any())
    {
        <div class = "mt-5">
            <h4 class = "fw-bold mb-4 text-primary">
                <i class = "fa fa-link me-2"></i> Sản phẩm liên quan
            </h4>
            <div class = "row g-4">
                @foreach (var rp in (List<Product>)ViewBag.RelatedProducts)
                {
                    <div class="col-md-3 col-sm-6">
                        <div class="card h-100 border-0 shadow-sm rounded-3 product-card d-flex flex-column">
                            <div class="position-relative overflow-hidden">
                                <img src="~/img/product/@rp.Image" 
                                     class="card-img-top img-fluid product-img" 
                                     alt="@rp.Name" />
                            </div>
                            <div class="card-body text-center d-flex flex-column">
                                <h6 class="card-title fw-semibold text-truncate-multiline" 
                                    title="@rp.Name">@rp.Name</h6>
                                <p class="text-danger fw-bold mb-2">@rp.Price.ToString("N0") ₫</p>
                                <div class="mt-auto">
                                    <a asp-action="Detail"
                                       asp-route-categorySlug="@rp.Category?.Slug"
                                       asp-route-brandSlug="@rp.Brand?.Slug"
                                       asp-route-productSlug="@rp.Slug"
                                       class="btn btn-outline-primary btn-sm px-3 rounded-pill">
                                        <i class="fa fa-eye me-1"></i> Xem chi tiết
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                }
            </div>
        </div>
    }

</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const addToCartBtn = document.querySelector(".btn-add-to-cart");
            document.querySelectorAll(".reply-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const id = btn.dataset.id;
                    const form = document.getElementById(`reply-form-${id}`);
                    if (form) form.classList.toggle("d-none");
                });
            });
            addToCartBtn?.addEventListener("click", function (e) {
                e.preventDefault();

                const productId = this.dataset.id;
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                const params = new URLSearchParams();
                params.append("Id", productId);
                params.append("__RequestVerificationToken", token);

                fetch('/User/Cart/Add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: params
                })

                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            showToast(data.message, "success");
                            document.querySelector("#cartCount").textContent = data.cartCount;
                        } else {
                            showToast("Thêm không thành công", "danger");
                        }
                    })
            });

            function showToast(message, type) {
                const toastContainer = document.getElementById("toast-container") || createToastContainer();

                const toast = document.createElement("div");
                toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
                toast.setAttribute("role", "alert");
                toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast" aria-label="Close"></button>
            </div>`;
                toastContainer.appendChild(toast);

                setTimeout(() => toast.remove(), 3000);
            }

            function createToastContainer() {
                const container = document.createElement("div");
                container.id = "toast-container";
                container.style.position = "fixed";
                container.style.top = "1rem";
                container.style.right = "1rem";
                container.style.zIndex = "1055";
                document.body.appendChild(container);
                return container;
            }


        });


    </script>
}
