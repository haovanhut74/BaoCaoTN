@model List<MyWebApp.Models.Product>

<link rel = "stylesheet" href = "~/css/User/Product.css"/>

<div class = "row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-4">
    @if (!Model.Any())
    {
        <div class = "col-12">
            <div class = "empty-state fade-in">
                <div class = "empty-state-icon">
                    <i class = "fas fa-search"></i>
                </div>
                <h3 class = "text-muted mb-3">Không có sản phẩm nào phù hợp</h3>
                <p class = "text-muted">Hãy thử điều chỉnh bộ lọc hoặc tìm kiếm với từ khóa khác</p>
            </div>
        </div>
    }
    else
    {
        @foreach (var item in Model)
        {
            <div class = "col fade-in">
                <div class = "card h-100 shadow-sm border-0 product-card">
                    <div class = "product-image-container">
                        <a
                            asp-area = "User"
                            asp-controller = "Product"
                            asp-action = "Detail"
                            asp-route-categorySlug = "@item.Category?.Slug"
                            asp-route-brandSlug = "@item.Brand?.Slug"
                            asp-route-productSlug = "@item.Slug"
                        >
                            <img
                                src = "~/img/product/@item.MainImage"
                                class = "product-image"
                                alt = "@item.Name"
                            />
                            <div class = "image-overlay"></div>
                        </a>
                    </div>

                    <div class = "card-body d-flex flex-column">
                        <h5 class = "product-title">@item.Name</h5>

                        <div class = "product-meta">
                            <i class = "fas fa-tag"></i>
                            <span>@item.Category?.Name</span>
                        </div>

                        <div class = "product-meta">
                            <i class = "fas fa-copyright"></i>
                            <span>@item.Brand?.Name</span>
                        </div>

                        <div class = "product-meta">
                            <i class = "fas fa-calendar"></i>
                            <span>Đăng bán: @item.CreatedAt.ToString("dd/MM/yyyy")</span>
                        </div>

                        <div class = "mt-auto">
                            <p>Giá gốc: @item.Price.ToString("N0") VND</p>
                            @if (item.DiscountPercent is > 0)
                            {
                                <p>Giá giảm: <span class = "text-danger">@item.DiscountPrice?.ToString("N0") VND</span>
                                    (<span>@item.DiscountPercent %</span>)</p>
                            }

                            @if (item.Sold > 0)
                            {
                                <div class = "sold-info">
                                    <i class = "fas fa-fire me-1"></i>
                                    Đã bán: <strong>@item.Sold</strong>
                                </div>
                            }

                            <a
                                asp-area = "User"
                                asp-controller = "Product"
                                asp-action = "Detail"
                                asp-route-categorySlug = "@item.Category?.Slug"
                                asp-route-brandSlug = "@item.Brand?.Slug"
                                asp-route-productSlug = "@item.Slug"
                                class = "btn btn-primary-modern btn-modern w-100 mt-2"
                            >
                                <i class = "fas fa-eye me-1"></i> Xem chi tiết
                            </a>

                            @if (item.Quantity > 0)
                            {
                                <button
                                    type = "button"
                                    class = "btn btn-success-modern btn-modern mt-2 btn-add-to-cart w-100"
                                    data-id = "@item.Id"
                                >
                                    <i class = "fas fa-cart-plus me-1"></i> Thêm vào giỏ hàng
                                </button>
                            }
                            else
                            {
                                <button
                                    type = "button"
                                    class = "btn btn-disabled btn-modern mt-2 w-100"
                                    disabled
                                >
                                    <i class = "fas fa-ban me-1"></i> Hết hàng
                                </button>
                            }
                        </div>
                        <div class = "form-check mt-2">
                            <input class = "form-check-input compare-checkbox" type = "checkbox" value = "@item.Id" id = "compare-@item.Id">
                            <label class = "form-check-label" for = "compare-@item.Id">So sánh</label>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>
<!-- Nút So sánh duy nhất -->
<div class = "mt-3 text-center">
    <button id = "compareBtn" class = "btn btn-primary">
        <i class = "fas fa-balance-scale me-1"></i> So sánh sản phẩm
    </button>
</div>

<!-- Nút So sánh duy nhất -->
<div class = "modal fade" id = "compareModal" tabindex = "-1" aria-labelledby = "compareModalLabel" aria-hidden = "true">
    <div class = "modal-dialog modal-xl modal-dialog-scrollable">
        <div class = "modal-content">
            <div class = "modal-header">
                <h5 class = "modal-title" id = "compareModalLabel">So sánh sản phẩm</h5>
                <button type = "button" class = "btn-close" data-bs-dismiss = "modal" aria-label = "Close"></button>
            </div>

            <div class = "modal-body">
                <div id = "compareTableContainer" class = "table-responsive"></div>
            </div>
        </div>
    </div>
</div>




<script>
    document.addEventListener('DOMContentLoaded', function () {
        const compareBtn = document.getElementById("compareBtn");
        if (!compareBtn) return;

        compareBtn.addEventListener("click", function (e) {
            e.preventDefault();

            const selectedIds = Array.from(document.querySelectorAll(".compare-checkbox:checked"))
                .map(cb => cb.value);

            if (selectedIds.length < 2) {
                alert("Vui lòng chọn ít nhất 2 sản phẩm để so sánh.");
                return;
            }

            fetch('@Url.Action("ComparePartial", "Product", new { area = "User" })?productIds=' + selectedIds.join("&productIds="))
                .then(res => res.text())
                .then(html => {
                    document.getElementById("compareTableContainer").innerHTML = html;

                    // Hiển thị modal
                    const compareModalEl = document.getElementById('compareModal');
                    const compareModal = new bootstrap.Modal(compareModalEl, {
                        backdrop: false,
                        keyboard: true
                    });
                    compareModal.show();
                })
                .catch(err => {
                    console.error(err);
                    alert("Có lỗi xảy ra, vui lòng thử lại.");
                });
        });
    });
</script>

